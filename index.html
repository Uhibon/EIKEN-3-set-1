<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boo-riculum EIKEN 3 set 1</title>
  <link rel="icon" type="image/png" href="booha-ghost.png">
  <style>
    :root{
      --ink:#1f2937; /* slate-800 */
      --muted:#6b7280; /* gray-500 */
      --paper:#fffaf0; /* ivory */
      --accent:#7c3aed; /* violet-600 */
      --accent-2:#14b8a6; /* teal-500 */
      --ok:#22c55e; --bad:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif;
      color:var(--ink);
      background:url('booha-1.jpg') center/cover fixed no-repeat;
      display:grid; grid-template-columns: 160px 1fr; grid-template-rows: 64px 1fr; grid-template-areas:
        "side top"
        "side main";
    }

    /* Top bar (brand + meter + global EN/JP) */
    .top{
      grid-area:top; display:flex; align-items:center; gap:12px; padding:10px 16px;
      background:#ffffffcc; backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid #e5e7eb; position:sticky; top:0; z-index:10;
    }
    .brand{font-weight:800; letter-spacing:.2px}
    .spacer{flex:1}
    .progress{display:flex; align-items:center; gap:10px}
    .bar{height:8px; width:200px; background:#e5e7eb; border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); width:0%}
    .seg{display:inline-flex; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden;}
    .seg button{padding:6px 10px; border:0; background:white; cursor:pointer; font-weight:700}
    .seg button.active{background:#111827; color:#fff}

    /* Sidebar: Booha ghost + bilingual mode buttons */
    .side{
      grid-area:side; position:sticky; top:0; height:100vh; background:#121826; color:white;
      display:flex; flex-direction:column; align-items:center; gap:10px; padding:14px 10px;
    }
    .ghost{line-height:1; margin:8px 0}
    .mode-btn{
      width:100%; padding:10px 10px; text-align:center; border-radius:12px;
      background:#1f2937; color:#cbd5e1; cursor:pointer; user-select:none;
      border:1px solid #253244; transition:transform .12s ease, background .2s;
      font-weight:800; line-height:1.25;
    }
    .mode-btn small{display:block; font-weight:600; opacity:.9}
    .mode-btn:hover{transform:translateY(-2px)}
    .mode-btn.active{background:#8b5cf6; color:white; border-color:transparent}

    /* Main */
    .main{grid-area:main; padding:18px;}
    .canvas{ max-width:980px; margin:0 auto; display:grid; gap:18px; grid-template-columns: 1fr; align-items:center; justify-items:center; }

    /* Notecards */
    .notecard{
      width:min(780px, 90vw); min-height:260px; background:var(--paper); border:1px solid #e2d6c5; border-radius:20px; box-shadow:0 12px 30px rgba(0,0,0,.07);
      padding:22px 24px; position:relative; overflow:hidden;
    }
    .notecard:before{content:""; position:absolute; inset:0; background:repeating-linear-gradient(#0000, #0000 30px, rgba(124,58,237,.06) 31px); pointer-events:none}
    .notecard h2{margin:0 0 8px; font-size:28px}
    .note-sub{color:var(--muted); font-size:15px}
    .big{font-size:40px; font-weight:800; letter-spacing:.2px}

    /* Controls */
    .controls{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:14px}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid #e5e7eb; background:white; cursor:pointer; font-weight:600}
    .btn.primary{background:var(--accent); color:white; border-color:transparent}
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    /* Quiz / choices */
    .quiz{display:grid; gap:16px}
    .choice{padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; background:white; cursor:pointer}
    .choice.correct{border-color:var(--ok); background:#ecfdf5}
    .choice.wrong{border-color:var(--bad); background:#fef2f2}

    /* Reading */
    .reading{line-height:1.7; font-size:18px}
    .muted{color:var(--muted)}

    /* Audio + rate controls */
    .audio-wrap{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .audio-btn{ width:46px; height:46px; border-radius:999px; border:0; cursor:pointer; display:grid; place-items:center; background:#ef4444; color:#fff; font-weight:900; box-shadow:0 6px 16px rgba(239,68,68,.35); }
    .audio-btn:active{transform:translateY(1px)}
    .rates{display:inline-flex; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden}
    .rates button{border:0; background:white; padding:6px 10px; cursor:pointer; font-weight:700; font-size:13px}
    .rates button.active{background:#111827; color:#fff}

    /* Responsive */
    @media (max-width:740px){
      body{grid-template-columns:136px 1fr}
      .bar{width:140px}
      .notecard{padding:18px}
      .notecard h2{font-size:24px}
      .big{font-size:34px}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="side" aria-label="Modes">
    <div class="ghost" title="Booha buddy">
      <img src="booha-ghost.png" alt="Booha Ghost" style="width:44px;height:auto;display:block;">
    </div>
    <div class="mode-btn active" data-mode="vocab">Vocab<small>ことば</small></div>
    <div class="mode-btn" data-mode="sentences">Sentences<small>ぶん</small></div>
    <div class="mode-btn" data-mode="qa">Q&amp;A<small>しつもん</small></div>
    <div class="mode-btn" data-mode="reading">Reading<small>よみもの</small></div>
    <div class="mode-btn" data-mode="quiz">Quiz<small>クイズ</small></div>
  </aside>

  <!-- Top -->
  <header class="top">
    <div class="brand">Boo-riculum EIKEN 3 set 1</div>
    <div class="spacer"></div>
    <div class="progress">
      <div class="bar" aria-label="Progress"><span id="progress"></span></div>
      <div class="seg" id="global-lang">
        <button data-lang="EN" class="active">EN</button>
        <button data-lang="JP">JP</button>
      </div>
    </div>
  </header>

  <main class="main">
    <section class="canvas" id="canvas"></section>
  </main>

  <!-- Templates -->
  <template id="tpl-vocab">
    <div class="notecard">
      <h2 class="muted" style="margin:0 0 6px 0">Vocabulary</h2>
      <div class="audio-wrap">
        <div class="big" data-bind="term"></div>
        <button class="audio-btn" title="Play (41–60)">▶</button>
        <div class="rates">
          <button data-rate="0.5">0.5×</button>
          <button data-rate="0.8">0.8×</button>
          <button data-rate="1.0">1.0×</button>
        </div>
      </div>
      <div class="note-sub" data-bind="hint"></div>
      <div style="margin-top:16px">
        <div><strong>Example:</strong> <span data-bind="ex"></span></div>
        <div class="muted" style="margin-top:6px" data-bind="exjp"></div>
      </div>
      <div class="controls">
        <button class="btn" data-key="prev">◀︎ Back</button>
        <div class="muted"><span data-bind="index"></span> / <span data-bind="total"></span></div>
        <button class="btn primary" data-key="next">Next ▶︎</button>
      </div>
    </div>
  </template>

  <template id="tpl-sent">
    <div class="notecard">
      <h2 class="muted" style="margin:0 0 6px 0">Useful Sentence</h2>
      <div class="audio-wrap">
        <div class="big" data-bind="sent"></div>
        <button class="audio-btn" title="Play (1–20)">▶</button>
        <div class="rates">
          <button data-rate="0.5">0.5×</button>
          <button data-rate="0.8">0.8×</button>
          <button data-rate="1.0">1.0×</button>
        </div>
      </div>
      <div class="note-sub" data-bind="sentjp"></div>
      <div class="controls">
        <button class="btn" data-key="prev">◀︎ Back</button>
        <div class="muted"><span data-bind="index"></span> / <span data-bind="total"></span></div>
        <button class="btn primary" data-key="next">Next ▶︎</button>
      </div>
    </div>
  </template>

  <template id="tpl-qa">
    <div class="notecard">
      <h2 class="muted" style="margin:0 0 6px 0">Interview Practice</h2>
      <div class="audio-wrap">
        <div class="big" data-bind="q"></div>
        <button class="audio-btn" title="Play (21–40)">▶</button>
        <div class="rates">
          <button data-rate="0.5">0.5×</button>
          <button data-rate="0.8">0.8×</button>
          <button data-rate="1.0">1.0×</button>
        </div>
      </div>
      <div class="note-sub" style="margin-top:8px"><strong>Model:</strong> <span data-bind="a"></span></div>
      <div class="muted" style="margin-top:6px" data-bind="ajp"></div>
      <div class="controls">
        <button class="btn" data-key="prev">◀︎ Back</button>
        <div class="muted"><span data-bind="index"></span> / <span data-bind="total"></span></div>
        <button class="btn primary" data-key="next">Next ▶︎</button>
      </div>
    </div>
  </template>

  <template id="tpl-read">
    <div class="notecard">
      <h2 class="muted" style="margin:0 0 6px 0">Reading</h2>
      <div class="audio-wrap" style="margin-bottom:6px">
        <button class="audio-btn" title="Play (61–70)">▶</button>
        <div class="rates">
          <button data-rate="0.5">0.5×</button>
          <button data-rate="0.8">0.8×</button>
          <button data-rate="1.0">1.0×</button>
        </div>
      </div>
      <div class="reading" data-bind="passage"></div>
      <div class="quiz" style="margin-top:12px" data-bind="qwrap"></div>
      <div class="controls">
        <button class="btn" data-key="prev">◀︎ Back</button>
        <div class="muted"><span data-bind="index"></span> / <span data-bind="total"></span></div>
        <button class="btn primary" data-key="next">Next ▶︎</button>
      </div>
    </div>
  </template>

  <template id="tpl-quiz">
    <div class="notecard">
      <h2 class="muted">Quick Quiz</h2>
      <div style="font-size:22px; font-weight:700" data-bind="q"></div>
      <div class="quiz" style="margin-top:12px" data-bind="choices"></div>
      <div class="controls">
        <button class="btn" data-key="prev">◀︎ Back</button>
        <div class="muted"><span data-bind="index"></span> / <span data-bind="total"></span></div>
        <button class="btn primary" data-key="next">Next ▶︎</button>
      </div>
    </div>
  </template>

  <script>
    // --- Data (20/20/20/10/20) ---
    const data = {
      vocab: [
        {en:"always", jp:"いつも", ex:"I always do my homework after dinner.", exjp:"私はいつも夕食の後に宿題をします。"},
        {en:"sometimes", jp:"ときどき", ex:"She sometimes goes to the library.", exjp:"彼女はときどき図書館へ行きます。"},
        {en:"before", jp:"〜の前に", ex:"Wash your hands before lunch.", exjp:"昼食の前に手を洗いましょう。"},
        {en:"after", jp:"〜の後で", ex:"After school, I play soccer.", exjp:"放課後、私はサッカーをします。"},
        {en:"because", jp:"〜なので", ex:"I stayed home because it was rainy.", exjp:"雨だったので家にいました。"},
        {en:"during", jp:"〜の間", ex:"Be quiet during the test.", exjp:"テストの間は静かにしてください。"},
        {en:"invitation", jp:"しょうたい", ex:"Thank you for the invitation.", exjp:"ご招待ありがとうございます。"},
        {en:"visit", jp:"たずねる／行く", ex:"We will visit a museum this Sunday.", exjp:"今週日曜日に博物館を訪れます。"},
        {en:"hospital", jp:"びょういん", ex:"My mother works at a hospital.", exjp:"母は病院で働いています。"},
        {en:"station", jp:"えき", ex:"Let's meet at the station.", exjp:"駅で会いましょう。"},
        {en:"homework", jp:"しゅくだい", ex:"Do your homework first.", exjp:"まず宿題をしなさい。"},
        {en:"practice", jp:"れんしゅうする", ex:"I practice the piano every day.", exjp:"私は毎日ピアノを練習します。"},
        {en:"exercise", jp:"うんどう", ex:"Exercise is good for your health.", exjp:"運動は健康に良いです。"},
        {en:"healthy", jp:"けんこうな", ex:"I want to eat healthy food.", exjp:"私は健康的な食べ物を食べたいです。"},
        {en:"weather", jp:"てんき", ex:"The weather is sunny today.", exjp:"今日は天気が晴れです。"},
        {en:"cloudy", jp:"くもり", ex:"It will be cloudy tomorrow.", exjp:"明日はくもりでしょう。"},
        {en:"windy", jp:"かぜがつよい", ex:"It's windy outside.", exjp:"外は風が強いです。"},
        {en:"borrow", jp:"かりる", ex:"Can I borrow your pen?", exjp:"ペンを借りてもいいですか。"},
        {en:"return", jp:"かえす", ex:"Please return the book by Friday.", exjp:"金曜日までに本を返してください。"},
        {en:"stationery", jp:"ぶんぼうぐ", ex:"I bought some stationery.", exjp:"文房具を買いました。"}
      ],
      sentences: [
        {en:"May I open the window?", jp:"まどをあけてもいいですか。"},
        {en:"Could you tell me the way to the station?", jp:"えきまでの みちを おしえてください。"},
        {en:"I have a sore throat.", jp:"のどが いたいです。"},
        {en:"I usually take a bus to school.", jp:"たいてい バスで がっこうへ いきます。"},
        {en:"I’m looking forward to the school trip.", jp:"しゅうがくりょこうが たのしみです。"},
        {en:"Please speak more slowly.", jp:"もっと ゆっくり はなしてください。"},
        {en:"I forgot my homework.", jp:"しゅくだいを わすれました。"},
        {en:"What time does the library open?", jp:"としょかんは なんじに あきますか。"},
        {en:"Can I try this on?", jp:"これを しちゃく しても いいですか。"},
        {en:"It takes about twenty minutes.", jp:"やく20ふん かかります。"},
        {en:"I have to help my mother.", jp:"おかあさんを てつだわないと いけません。"},
        {en:"We don’t have school today.", jp:"きょうは がっこうが ありません。"},
        {en:"Do you have any plans this weekend?", jp:"こんしゅうまつ よていは ありますか。"},
        {en:"I’m not sure.", jp:"よく わかりません。"},
        {en:"Could you pass me the salt?", jp:"しおを とって くれますか。"},
        {en:"I need to finish this by tonight.", jp:"こんやまでに これを おわらせる ひつようが あります。"},
        {en:"What does this word mean?", jp:"この ことばは どういう いみですか。"},
        {en:"Can you play any instruments?", jp:"なにか がっきが ひけますか。"},
        {en:"I was absent from school yesterday.", jp:"きのう がっこうを けっせき しました。"},
        {en:"Don’t forget to bring your PE uniform.", jp:"たいそうふくを わすれないで ください。"}
      ],
      qa: [
        {q:"What time do you usually get up?", a:"I usually get up at six thirty.", ajp:"たいてい 6じ30ふん に おきます。"},
        {q:"What do you do after school?", a:"I do my homework and play soccer.", ajp:"しゅくだいを して サッカーを します。"},
        {q:"How do you go to school?", a:"I go to school by bicycle.", ajp:"じてんしゃで がっこうへ いきます。"},
        {q:"What is your favorite subject?", a:"My favorite subject is English.", ajp:"いちばん すきな きょうかは えいごです。"},
        {q:"What did you do last Sunday?", a:"I visited my grandparents.", ajp:"せんしゅう の にちようびは そふぼを たずねました。"},
        {q:"Where would you like to go in the future?", a:"I’d like to go to Canada.", ajp:"しょうらい カナダに いきたいです。"},
        {q:"What do you eat for breakfast?", a:"I usually eat toast and eggs.", ajp:"たいてい トーストと たまごを たべます。"},
        {q:"Do you belong to any club?", a:"Yes, I’m in the soccer club.", ajp:"はい、サッカーぶに はいっています。"},
        {q:"Tell me about your family.", a:"There are four people in my family.", ajp:"かぞくは 4にん です。"},
        {q:"What do you do on weekends?", a:"I hang out with friends or study.", ajp:"ともだちと あそぶ か べんきょうします。"},
        {q:"Do you have any pets?", a:"Yes, I have a cat.", ajp:"はい、ねこを かっています。"},
        {q:"What kind of books do you like?", a:"I like mystery books.", ajp:"ミステリーの ほんが すきです。"},
        {q:"What season do you like and why?", a:"I like spring because the weather is warm.", ajp:"あたたかいので はるが すきです。"},
        {q:"What time do you go to bed?", a:"I go to bed at ten.", ajp:"10じに ねます。"},
        {q:"Who do you admire?", a:"I admire my father.", ajp:"おとうさんを そんけいして います。"},
        {q:"Which place would you like to visit in Japan?", a:"I’d like to visit Kyoto.", ajp:"きょうとに いきたいです。"},
        {q:"How often do you study English?", a:"I study English every day.", ajp:"まいにち えいごを べんきょうします。"},
        {q:"What do you do to stay healthy?", a:"I exercise and eat vegetables.", ajp:"うんどうして やさいを たべます。"},
        {q:"What are you good at?", a:"I’m good at drawing.", ajp:"えを かくのが とくいです。"},
        {q:"What do you want to be in the future?", a:"I want to be a teacher.", ajp:"しょうらい せんせいに なりたいです。"}
      ],
      reading: [
        {
          passage: `Ken likes plants. Every morning, he waters the flowers in his garden. On Sundays, he visits a small park near his house and takes pictures of trees. He wants to make a book about plants someday.`,
          questions:[
            {q:"What does Ken do every morning?", choices:["He reads books.","He waters the flowers.","He visits a park.","He takes the train."], answer:1},
            {q:"When does Ken visit the park?", choices:["On Sundays","On Fridays","Every night","In winter"], answer:0}
          ]
        },
        {
          passage: `My school has a clean library. Students can borrow two books for one week. I usually borrow a science book and a story book. The library opens at nine and closes at five.`,
          questions:[
            {q:"How many books can students borrow?", choices:["One","Two","Three","Four"], answer:1},
            {q:"What time does the library close?", choices:["Four","Five","Six","Seven"], answer:1}
          ]
        },
        {
          passage: `Yumi’s town will have a summer festival next month. Many people will wear yukata and enjoy food from small shops. Yumi wants to help at a drink stand with her friends.`,
          questions:[
            {q:"When is the festival?", choices:["This week","Next month","Last year","Tomorrow"], answer:1},
            {q:"What does Yumi want to do?", choices:["Dance on stage","Help at a drink stand","Play baseball","Watch fireworks at home"], answer:1}
          ]
        },
        {
          passage: `Mr. Tanaka has a small bakery. He wakes up at four every morning to bake bread. Many students stop by his shop before school to buy sweet bread.`,
          questions:[
            {q:"What time does Mr. Tanaka wake up?", choices:["At four","At six","At eight","At ten"], answer:0},
            {q:"Who often buys bread there?", choices:["Teachers","Students","Tourists","Doctors"], answer:1}
          ]
        },
        {
          passage: `Our English teacher started a pen-pal project. I write letters to a student in Australia. We talk about school life and favorite sports. I want to visit her someday.`,
          questions:[
            {q:"Where is the pen pal from?", choices:["Canada","Australia","Japan","India"], answer:1},
            {q:"What do they write about?", choices:["Math problems","Weather only","School life and sports","Movies only"], answer:2}
          ]
        },
        {
          passage: `There is a new bus route in my city. The bus comes every fifteen minutes. It is cheaper than the train, so many people use it to go shopping.`,
          questions:[
            {q:"How often does the bus come?", choices:["Every five minutes","Every ten minutes","Every fifteen minutes","Every hour"], answer:2},
            {q:"Why do many people use the bus?", choices:["It is cheaper than the train","It is faster than airplanes","It is free","It is purple"], answer:0}
          ]
        },
        {
          passage: `Aya joined the school art club last year. She practices drawing after school on Tuesdays and Thursdays. Next month, the club will hold a small exhibition in the library.`,
          questions:[
            {q:"When does Aya practice?", choices:["On Mondays and Fridays","On Tuesdays and Thursdays","On Saturdays","Every day"], answer:1},
            {q:"Where will the exhibition be?", choices:["In the gym","In the library","In the park","In a museum"], answer:1}
          ]
        },
        {
          passage: `Taro wants to be a nurse. He likes helping people and studying science. He reads books about hospitals and sometimes watches videos about first aid.`,
          questions:[
            {q:"What does Taro want to be?", choices:["A teacher","A nurse","A cook","A singer"], answer:1},
            {q:"What does he read?", choices:["Comics only","Books about hospitals","Math textbooks","Novels only"], answer:1}
          ]
        },
        {
          passage: `My grandmother grows tomatoes on her balcony. She gives us fresh tomatoes in summer. We often make salad together and talk about her childhood.`,
          questions:[
            {q:"Where does she grow tomatoes?", choices:["In the park","On her balcony","At school","In the forest"], answer:1},
            {q:"What do we make with tomatoes?", choices:["Soup","Salad","Juice","Pizza only"], answer:1}
          ]
        },
        {
          passage: `Our class cleaned the beach last Saturday. We picked up plastic bottles and cans for two hours. After that, we ate lunch and played volleyball.`,
          questions:[
            {q:"What did the class do?", choices:["They went swimming","They cleaned the beach","They studied math","They watched a movie"], answer:1},
            {q:"How long did they clean?", choices:["One hour","Two hours","Three hours","All day"], answer:1}
          ]
        }
      ],
      quiz: [
        {q:"『いつも』の英語は？", choices:["often","always","usually","sometimes"], answer:1},
        {q:"borrow の反対は？", choices:["return","bring","keep","buy"], answer:0},
        {q:"It is very ____ today. I can’t use an umbrella.", choices:["sunny","rainy","windy","cloudy"], answer:2},
        {q:"Because を使って正しい文は？", choices:["I go school because bus.","I stayed home because I was sick.","Because I sick, stay home.","I because stayed home."], answer:1},
        {q:"‘文房具’ は英語で？", choices:["library","museum","stationery","bakery"], answer:2},
        {q:"May I open the window? の返事として自然なのは？", choices:["Yes, you may.","No, you don’t.","Yes, I do.","No, I am."], answer:0},
        {q:"I’m looking forward to the school trip. の意味は？", choices:["修学旅行が心配です","修学旅行を楽しみにしています","修学旅行に遅れます","修学旅行をやめます"], answer:1},
        {q:"‘約20分かかります’ の英訳は？", choices:["I take about twenty minutes.","It takes about twenty minutes.","It is twenty about minutes.","Takes twenty minutes about it."], answer:1},
        {q:"healthy の最も近い意味は？", choices:["楽しい","健康な","忙しい","高い"], answer:1},
        {q:"We don’t have school today. の日本語は？", choices:["今日は学校があります","今日は学校がありません","今日は学校へ行きます","今日は宿題がありません"], answer:1},
        {q:"‘〜の間’ の英語は？", choices:["before","after","during","between"], answer:2},
        {q:"‘くもり’ は？", choices:["cloudy","windy","rainy","snowy"], answer:0},
        {q:"Please ____ the book by Friday.", choices:["borrow","keep","read","return"], answer:3},
        {q:"I usually go to school ____ bus.", choices:["by","on","to","in"], answer:0},
        {q:"‘招待’ は英語で？", choices:["vacation","invitation","information","station"], answer:1},
        {q:"Can I ____ your pen?", choices:["lend","borrow","buy","open"], answer:1},
        {q:"I have to ____ my mother.", choices:["help","play","watch","enjoy"], answer:0},
        {q:"What time does the library ____?", choices:["close","open","start","stop"], answer:1},
        {q:"He is very ____. He runs every day.", choices:["healthy","hungry","busy","late"], answer:0},
        {q:"‘風が強い’ は英語で？", choices:["rainy","sunny","windy","storm"], answer:2}
      ]
    };

    // --- State ---
    const state = {
      mode: 'vocab',
      index: 0,
      lang: 'EN',     // global language: EN or JP
      rate: 1.0,      // current playback rate
      lastNav: 0,     // debounce
    };

    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    // --- Audio (single shared instance) ---
    const player = new Audio();
    player.preload = 'none';
    player.playbackRate = state.rate;

    // Audio mapping:
    // Vocab 1..20 => 41..60   Sentences 1..20 => 1..20
    // Q&A   1..20 => 21..40   Reading   1..10 => 61..70
    function playVocabAudio(i){     const n = 41 + i; player.src = `${n}.m4a`; player.currentTime = 0; player.play(); }
    function playSentenceAudio(i){  const n = 1 + i;  player.src = `${n}.m4a`; player.currentTime = 0; player.play(); }
    function playQaAudio(i){        const n = 21 + i; player.src = `${n}.m4a`; player.currentTime = 0; player.play(); }
    function playReadingAudio(i){   const n = 61 + i; player.src = `${n}.m4a`; player.currentTime = 0; player.play(); }

    // --- UI helpers ---
    function setProgress(){
      const total = data[state.mode].length;
      const p = ((state.index+1)/total)*100;
      $('#progress').style.width = p + '%';
    }
    function navDebounced(fn){
      const now = Date.now();
      if(now - state.lastNav < 350) return; // debounce 350ms
      state.lastNav = now;
      fn();
    }
    function bindRates(container){
      const btns = Array.from(container.querySelectorAll('button[data-rate]'));
      const setActive = (r)=>{
        btns.forEach(b=>b.classList.toggle('active', b.dataset.rate === r.toString()));
      };
      // reflect global state
      setActive(state.rate.toFixed(1));
      btns.forEach(b=>{
        b.addEventListener('click',()=>{
          state.rate = parseFloat(b.dataset.rate);
          player.playbackRate = state.rate;
          setActive(b.dataset.rate);
        });
      });
    }

    function render(){
      const wrap = $('#canvas');
      wrap.innerHTML = '';
      const list = data[state.mode];
      const item = list[state.index];
      const tplId = { vocab:'tpl-vocab', sentences:'tpl-sent', qa:'tpl-qa', reading:'tpl-read', quiz:'tpl-quiz' }[state.mode];
      const node = document.importNode($("#"+tplId).content, true);

      // Bind per mode
      if(state.mode==='vocab'){
        const showEN = state.lang==='EN';
        $("[data-bind=term]", node).textContent = showEN ? item.en : item.jp;
        $("[data-bind=hint]", node).textContent = showEN ? item.jp : item.en;
        $("[data-bind=ex]", node).textContent = item.ex;
        $("[data-bind=exjp]", node).textContent = item.exjp;
        node.querySelector('.audio-btn').addEventListener('click', ()=> playVocabAudio(state.index));
        bindRates(node.querySelector('.rates'));
      }
      if(state.mode==='sentences'){
        const showEN = state.lang==='EN';
        $("[data-bind=sent]", node).textContent = showEN ? item.en : item.jp;
        $("[data-bind=sentjp]", node).textContent = showEN ? item.jp : item.en;
        node.querySelector('.audio-btn').addEventListener('click', ()=> playSentenceAudio(state.index));
        bindRates(node.querySelector('.rates'));
      }
      if(state.mode==='qa'){
        const showEN = state.lang==='EN';
        $("[data-bind=q]", node).textContent = item.q;
        $("[data-bind=a]", node).textContent = showEN ? item.a : item.ajp;
        $("[data-bind=ajp]", node).textContent = showEN ? item.ajp : item.a;
        node.querySelector('.audio-btn').addEventListener('click', ()=> playQaAudio(state.index));
        bindRates(node.querySelector('.rates'));
      }
      if(state.mode==='reading'){
        node.querySelector('.audio-btn').addEventListener('click', ()=> playReadingAudio(state.index));
        bindRates(node.querySelector('.rates'));
        $("[data-bind=passage]", node).textContent = item.passage;
        const qwrap = $("[data-bind=qwrap]", node);
        item.questions.forEach((q,qi)=>{
          const qDiv = document.createElement('div');
          qDiv.innerHTML = `<div style="font-weight:700">Q${qi+1}. ${q.q}</div>`;
          q.choices.forEach((c,ci)=>{
            const btn = document.createElement('div');
            btn.className = 'choice'; btn.textContent = c;
            btn.addEventListener('click',()=>{
              if(ci===q.answer){ btn.classList.add('correct'); } else {btn.classList.add('wrong');}
            }, {once:true});
            qDiv.appendChild(btn);
          });
          qwrap.appendChild(qDiv);
        });
      }
      if(state.mode==='quiz'){
        $("[data-bind=q]", node).textContent = item.q;
        const cWrap = $("[data-bind=choices]", node);
        item.choices.forEach((c,ci)=>{
          const d = document.createElement('div'); d.className='choice'; d.textContent=c;
          d.addEventListener('click',()=>{
            if(ci===item.answer){ d.classList.add('correct'); } else {d.classList.add('wrong');}
          }, {once:true});
          cWrap.appendChild(d);
        });
      }

      // Counters & nav
      const total = list.length;
      $("[data-bind=index]", node)?.append(state.index+1);
      $("[data-bind=total]", node)?.append(total);
      const prevBtn = $("[data-key=prev]", node);
      const nextBtn = $("[data-key=next]", node);
      prevBtn?.addEventListener('click',()=>{ navDebounced(()=>{ state.index = Math.max(0, state.index-1); render(); }); });
      nextBtn?.addEventListener('click',()=>{ navDebounced(()=>{ state.index = (state.index<total-1)? state.index+1 : 0; render(); }); });

      wrap.appendChild(node);
      setProgress();
    }

    // Sidebar mode buttons
    $$(".mode-btn").forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$(".mode-btn").forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        state.mode = btn.dataset.mode;
        state.index = 0;
        render();
      });
    });

    // Global EN/JP next to progress meter
    (function(){
      const seg = $("#global-lang");
      const btnEN = seg.querySelector('button[data-lang="EN"]');
      const btnJP = seg.querySelector('button[data-lang="JP"]');
      function setLang(L){
        state.lang = L;
        btnEN.classList.toggle('active', L==='EN');
        btnJP.classList.toggle('active', L==='JP');
        render();
      }
      btnEN.addEventListener('click', ()=> setLang('EN'));
      btnJP.addEventListener('click', ()=> setLang('JP'));
    })();

    // Keyboard shortcuts (debounced)
    window.addEventListener('keydown', (e)=>{
      if(['ArrowRight','d','D'].includes(e.key)){
        const now = Date.now(); if(now - state.lastNav >= 350){ state.lastNav = now; const total = data[state.mode].length; state.index = (state.index<total-1)? state.index+1 : 0; render(); }
      }
      if(['ArrowLeft','a','A'].includes(e.key)){
        const now = Date.now(); if(now - state.lastNav >= 350){ state.lastNav = now; state.index = Math.max(0, state.index-1); render(); }
      }
      if(['e','E'].includes(e.key)){ document.querySelector('#global-lang button[data-lang="EN"]').click(); }
      if(['j','J'].includes(e.key)){ document.querySelector('#global-lang button[data-lang="JP"]').click(); }
    });

    // Init
    render();
  </script>
</body>
</html>
